const t=([t],[e])=>t===e?0:t<e?1:-1,e=(e,n)=>{const r=t(e,n);return 0===r?e[1]===n[1]?0:e[1]<n[1]?1:-1:r},n=([t,n])=>-1===e(t,n)?[n,t]:[t,n],r=(t,e)=>t.reduce((t,n,r)=>(0!==r&&(t+="\n"),t+n.reduce((t,n)=>t+(c(n)?n.text:e?e(n):""),"")),""),o=t=>t.split("\n").map(t=>t?[{text:t}]:[]),s=t=>3!==t.t;class i extends Array{static from(t){return new i(...t)}insert(t,e){return this.push({t:2,o:t,i:e}),this}delete(t,e){return this.push({t:1,l:t,u:e}),this}select(t,e){return this.push({t:3,p:t,h:e}),this}transform(t){return this.reduce((t,e)=>s(e)?m(t,e):t,t)}}const c=t=>"text"in t,a=t=>c(t)?t.text.length:1,l=t=>t.reduce((t,e)=>t+a(e),0),u=(t,e)=>{const n=[...t];if(n.length)for(const t of e){const e=n.length-1,r=n[e];c(t)&&c(r)?n[e]={text:r.text+t.text}:n.push(t)}else n.push(...e);return n},f=(t,e)=>{for(let n=0;n<t.length;n++){const r=t[n],o=a(r);if(o>e){const o=t.slice(0,n),s=t.slice(n+1);if(c(r)){const t=r.text.slice(0,e),n=r.text.slice(e);t&&o.push({text:t}),n&&s.unshift({text:n})}else s.unshift(r);return[o,s]}e-=o}return[t,[]]},d=(t,e,n,r)=>{const[o]=n,[s]=r||n,i=f(t[n[0]],n[1]),c=i[0],a=r?f(t[r[0]],r[1])[1]:i[1],l=[...e];l.length?(l[0]=u(c,l[0]),l[l.length-1]=u(l[l.length-1],a)):l.push(u(c,a)),t.splice(o,s-o+1,...l)},p=t=>{switch(t.t){case 1:return 1===e(t.l,t.u);case 2:return!!r(t.i)}return!0},h=(t,e)=>{switch(e.t){case 1:d(t,[],e.l,e.u);break;case 2:d(t,e.i,e.o)}},m=(n,r)=>{switch(r.t){case 1:{const{l:o,u:s}=r;if(1!==e(n,o))return 1===e(s,n)?[n[0]+o[0]-s[0],n[1]+(0===t(s,n)?o[1]-s[1]:0)]:o;break}case 2:{const{o,i:s}=r,i=s.length,c=i-1;if(1!==e(n,o))return[n[0]+c,n[1]+(0===t(n,o)?l(s[i-1])-(0===c?0:o[1]):0)];break}}return n},y=(t,e,n)=>{const r=[...t],o=[...e];try{for(const r of n)p(r)&&(s(r)?(h(t,r),e[0]=m(e[0],r),e[1]=m(e[1],r)):(r.p&&(e[0]=r.p),r.h&&(e[1]=r.h)))}catch(n){console.error("rollback transaction:",n),t.length=0,t.push(...r),e[0]=o[0],e[1]=o[1]}},w=(t,e)=>(new i).delete(...n(e)),x=(t,e,r)=>{const[s,c]=n(e);return(new i).delete(s,c).insert(s,o(r))},_=(t,e,n)=>(new i).delete([0,0],[t.length-1,l(t[t.length-1])]).insert([0,0],o(n));let g,b,k,D,v,M=!1,E=!1;const O=t=>3===t.nodeType,I=t=>1===t.nodeType,S=t=>8===t.nodeType,B=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),H=t=>"false"===t.contentEditable||B.has(t.tagName),R=()=>b,A=()=>1===k?b.data.length:2===k?1:0,C=t=>{g.currentNode=g.currentNode.parentNode.children[t]},P=t=>{const e=t.nextSibling;return!!e&&!S(e)},L=()=>{for(;;){if(2===k){const t=b;for(;(b=g.nextNode())&&t.contains(b););}else b=g.nextNode();if(k=null,!b)break;if(D)if(D.contains(b)){if(M=!0,E)break}else if(M)break;if(O(b)){const t=b.data;if(t)return k="\n"===t?P(b)?3:6:1}else if(I(b)){if("BR"===b.tagName)return k=P(b)?3:5;if(H(b))return k=2;if(v(b))return k=4}}},T=(t,e,{m:n,_:r},o)=>{try{return v=r,g=n.createTreeWalker(e,5),o&&(o.k&&(g.currentNode=o.k,g.previousNode()),o.D&&(D=o.D),E=o.v||!1),t(L)}finally{g=b=k=D=null,M=E=!1}},V=Math.min,j="function"==typeof queueMicrotask?queueMicrotask:t=>{Promise.resolve().then(t)},F=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),N=t=>F.has(t.tagName),U=t=>t.ownerDocument,q=t=>U(t).getSelection(),G=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},K=(t,e,n)=>{const r=q(t);r.removeAllRanges(),r.addRange(e),n&&(r.collapseToEnd(),r.extend(e.startContainer,e.startOffset))},W=(t,n,[r,o],s)=>{const i=e(r,o),c=0===i,a=-1===i,l=a?o:r,u=a?r:o;if(0===l[0]&&0===l[1]&&c&&!n.hasChildNodes()){const e=t.createRange();return e.setStart(n,0),e.setEnd(n,0),K(n,e),!0}const f=J(n,l,s);if(!f)return!1;const d=c?f:J(n,u,s);if(!d)return!1;const p=t.createRange(),[h,m]=f,[y,w]=d;return I(h)?m<1?p.setStartBefore(h):p.setStartAfter(h):p.setStart(h,m),I(y)?w<1?p.setEndBefore(y):p.setEndAfter(y):p.setEnd(y,w),K(n,p,a),!0},J=(t,[e,n],r)=>T(t=>{let r,o=!1;for(;r=t();)if(4===r)o||(o=!0,0!==e&&C(e));else{const t=A();if(n<=t)return[R(),n];n-=t}},t,r),X=(t,e,n,r)=>{let o,s,i=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(I(e)&&!H(e)&&e.hasChildNodes()){const t=V(n,e.childNodes.length-1);e=e.childNodes[t],i=t===n,n=0}const c=((t,e)=>{let n=e;for(;;){const e=n.parentElement;if(e===t)break;n=e}return n})(t,e);return r._(c)?(o=c,s=(t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e})(o)):(o=t,s=0),T(t=>{let e,r=0;for(;e=t();)3===e?(s++,r=0):r+=A();return[s,r+n]},o,r,{D:e,v:i})},Y=(t,e,{startOffset:n,startContainer:r,endOffset:o,endContainer:s})=>{const i=X(t,r,n,e);return[i,r===s&&n===o?i:X(t,s,o,e)]},Z=t=>i.from(t.map(t=>2===t.t?{...t,i:[t.i.reduce((t,e)=>u(t,e),[])]}:t)),z=()=>{},Q=({schema:{single:r,js:s,doc:c,copy:a,paste:l},doc:u,isBlock:d=N,onChange:p,onKeyDown:h})=>{let m=[[0,0],[0,0]],w=!1,x=z;const _=()=>g.get()[0],g=(t=>{let e=0,n=0;const r=Date.now,o=[t],s=()=>o[e];return{get:s,set:t=>{o[e]=t},undo:()=>e>0?(e--,s()):void 0,redo:()=>e<o.length-1?(e++,s()):void 0,push:t=>{const s=r();0!==e&&s-n<500&&e--,n=s,o[++e]=t,o.splice(e+1),e>500&&(e--,o.shift())}}})([c(u),m]),b=[],k=t=>{w||(b.unshift(t),v(M))},D=new Set,v=t=>{D.has(t)||(D.add(t),j(()=>{D.delete(t),t()}))},M=()=>{if(b.length){let n,o=[..._()],i=[...m];for(;n=b.pop();)r&&(n=Z(n)),y(o,i,n);const c=_();e=c,(t=o).length===e.length&&t.every((t,n)=>t===e[n])||(g.set([c,m]),g.push([o,i]),p(s(o))),m=i}var t,e};return{input:c=>{if(!window.InputEvent||"function"!=typeof InputEvent.prototype.getTargetRanges)return console.error("beforeinput event is not supported."),z;const{contentEditable:u,role:y,ariaMultiLine:b,ariaReadOnly:D}=c,v=c.style.whiteSpace;c.role="textbox",c.style.whiteSpace="pre-wrap",r||(c.ariaMultiLine="true");let M=!1,E=!1,O=null,I=!1,S=!1,B=!1;const H=U(c),R={m:H,_:d};x=()=>{c.contentEditable=w?"false":"true",c.ariaReadOnly=w?"true":null},x();const A=((t,e)=>{let n=!1;const r=[],o=t=>{n&&r.push(...t)},s=new MutationObserver(t=>{o(t),n||e()}),i=()=>{o(s.takeRecords())};return s.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{M(t){!n&&t&&i(),n=t},O:()=>(i(),r.splice(0)),I(){r.splice(0),s.disconnect()}}})(c,()=>{S&&W(H,c,m,R)}),C=()=>{m=((t,e)=>{const n=q(t),r=G(n,t);if(!r)return[[0,0],[0,0]];const o=Y(t,e,r);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:2&(s=n.anchorNode,i=n.focusNode,s.compareDocumentPosition(i)))?[o[1],o[0]]:o;var s,i})(c,R)},P=()=>{const t=A.O();if(A.M(!1),t.length){let e;for(;e=t.pop();)if("childList"===e.type){const{target:t,removedNodes:n,addedNodes:r,nextSibling:o}=e;for(let e=n.length-1;e>=0;e--)t.insertBefore(n[e],o);for(let e=r.length-1;e>=0;e--)t.removeChild(r[e])}else e.target.nodeValue=e.oldValue;A.O(),E=W(H,c,m,R)}O&&k(O),I=!1,O=null},L=t=>{if(!I)if(h&&h(t))t.preventDefault();else if((t.metaKey||t.ctrlKey)&&!t.altKey&&"KeyZ"===t.code&&(t.preventDefault(),A.M(!1),!w)){const e=t.shiftKey?g.redo():g.undo();e&&(p(s(e[0])),m=e[1])}},T=()=>{I||P()},V=t=>{t.preventDefault();const n=t.inputType;if(n.startsWith("format"))return;if("historyUndo"===n||"historyRedo"===n)return;A.M(!0),I||C();const r=t.getTargetRanges()[0];if(r){const s=Y(c,R,r);let a="insertParagraph"===n||"insertLineBreak"===n?"\n":t.data;if(null==a){const e=t.dataTransfer;e&&(a=e.getData("text/plain"))}O||(O=(new i).select(...m)),0!==e(...s)&&O.delete(...s),a&&O.insert(s[0],o(a))}I||P()},j=()=>{I||C(),I=!0},F=()=>{P()},N=()=>{S=!0,C()},K=()=>{S=!1},J=()=>{E?E=!1:!S||I||B||C()},Z=r=>{C(),0!==e(...m)&&a(r,((e,n,r)=>0===t(n,r)?[f(f(e[n[0]],r[1])[0],n[1])[1]]:[f(e[n[0]],n[1])[1],...e.slice(n[0]+1,r[0]),f(e[r[0]],r[1])[0]])(_(),...n(m)),c)},Q=t=>{t.preventDefault(),Z(t.clipboardData)},$=t=>{t.preventDefault(),w||(Z(t.clipboardData),k((new i).delete(...n(m))))},tt=t=>{t.preventDefault();const[e,r]=n(m);k((new i).delete(e,r).insert(e,l(t.clipboardData,R)))},et=t=>{t.preventDefault();const e=t.dataTransfer,r=((t,e,{clientX:n,clientY:r},o)=>{if(t.caretPositionFromPoint){const s=t.caretPositionFromPoint(n,r);if(s)return X(e,s.offsetNode,s.offset,o)}else if(t.caretRangeFromPoint){const s=t.caretRangeFromPoint(n,r);if(s)return X(e,s.startContainer,s.startOffset,o)}})(H,c,t,R);if(e&&r){const t=new i;B&&t.delete(...n(m));const o=t.transform(r);t.select(o,o).insert(o,l(e,R)).select(o),k(t),c.focus({preventScroll:!0})}},nt=t=>{B=!0,Z(t.dataTransfer)},rt=()=>{B=!1};return H.addEventListener("selectionchange",J),c.addEventListener("keydown",L),c.addEventListener("input",T),c.addEventListener("beforeinput",V),c.addEventListener("compositionstart",j),c.addEventListener("compositionend",F),c.addEventListener("focus",N),c.addEventListener("blur",K),c.addEventListener("copy",Q),c.addEventListener("cut",$),c.addEventListener("paste",tt),c.addEventListener("drop",et),c.addEventListener("dragstart",nt),c.addEventListener("dragend",rt),()=>{M||(M=!0,x=z,c.contentEditable=u,c.role=y,c.ariaMultiLine=b,c.ariaReadOnly=D,c.style.whiteSpace=v,A.I(),H.removeEventListener("selectionchange",J),c.removeEventListener("keydown",L),c.removeEventListener("input",T),c.removeEventListener("beforeinput",V),c.removeEventListener("compositionstart",j),c.removeEventListener("compositionend",F),c.removeEventListener("focus",N),c.removeEventListener("blur",K),c.removeEventListener("copy",Q),c.removeEventListener("cut",$),c.removeEventListener("paste",tt),c.removeEventListener("drop",et),c.removeEventListener("dragstart",nt),c.removeEventListener("dragend",rt))}},command:(t,...e)=>{const n=t(_(),m,...e);n&&k(n)},readonly:t=>{w=t,x()}}},$=({multiline:t}={})=>({single:!t,js:r,doc:o,copy:(t,e)=>{t.setData("text/plain",r(e))},paste:t=>o(t.getData("text/plain"))}),tt=()=>"",et=({is:t,data:e,plain:n=tt})=>({is:t,data:e,plain:n}),nt=({multiline:t,void:e={}})=>{const n=Object.entries(e),s=new WeakMap,i=new WeakMap,a=t=>t.reduce((t,e)=>{if(c(e)){let n=s.get(e);n||s.set(e,n={type:"text",text:e.text}),t.push(n)}else t.push(i.get(e.data));return t},[]),l=t=>{for(const[e,r]of n)if(r.is(t)){const n=r.data(t);return i.set(n,{type:e,data:{...n}}),n}},u=t=>{if("text"===t.type)return{text:t.text};const{type:e,data:n}=t;return i.set(n,{type:e,data:n}),{data:n}};return{single:!t,js:t?t=>t.map(a):t=>a(t[0]),doc:e=>t?e.map(t=>t.map(u)):[e.map(u)],copy:(t,n,o)=>{t.setData("text/plain",r(n,t=>{const n=i.get(t.data);return e[n.type].plain(t.data)}));const s=document.createElement("div");s.appendChild(G(q(o),o).cloneContents()),t.setData("text/html",s.innerHTML)},paste:(t,e)=>{const n=t.getData("text/html");if(n){let t=(new DOMParser).parseFromString(n,"text/html").body,r=!1;for(const e of[...t.childNodes])S(e)?"StartFragment"===e.data?(r=!0,t=new DocumentFragment):"EndFragment"===e.data&&(r=!1):r&&t.appendChild(e);return((t,e,n)=>T(t=>{let e,r=null,o="",s=!1;const i=[],c=()=>{o&&(r||(r=[]),r.push({text:o}),o="")},a=()=>{c(),!r&&s&&(r=[]),r&&i.push(r),r=null,s=!1};for(;e=t();)if(4===e)a();else if(s=!0,1===e){let t=R().data;o+=t}else if(2===e){c();const t=R(),e=n(t);e&&r.push({data:e})}else 3===e&&a();return a(),i.length||i.push([]),i},t,e,void 0))(t,e,l)}return o(t.getData("text/plain"))}}};export{w as Delete,x as InsertText,_ as ReplaceAll,Q as createEditor,$ as plainSchema,nt as schema,et as voidNode};
//# sourceMappingURL=index.js.map
